---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { SITE_TITLE } from '../../consts';

export async function getStaticPaths() {
	const posts = await getCollection('blog');

	// Get all unique tags
	const tags = new Set<string>();
	posts.forEach((post) => {
		post.data.tags?.forEach((tag) => tags.add(tag));
	});

	return Array.from(tags).map((tag) => ({
		params: { tag },
		props: { tag },
	}));
}

const { tag } = Astro.props;

const posts = (await getCollection('blog'))
	.filter((post) => post.data.tags?.includes(tag))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Format date like "Jan 8, 2022"
const formatDate = (date: Date) => {
	return date.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'short',
		day: 'numeric',
	});
};
---

<BaseLayout title={`${tag} | ${SITE_TITLE}`} description={`Posts tagged with ${tag}`}>
	<h2 class="text-2xl font-sans mb-6">
		Posts tagged: <span class="text-accent">{tag}</span>
	</h2>
	<p class="text-muted mb-8">
		<a href="/archive" class="border-b border-accent hover:text-accent">&larr; Back to all posts</a>
	</p>
	<ul class="p-0">
		{posts.map((post) => (
			<li class="list-none mb-4">
				<a href={`/blog/${post.id}/`} class="hover:text-accent">
					<div class="font-sans text-sm">{post.data.title}</div>
					<div class="font-sans text-sm text-muted">{formatDate(post.data.pubDate)}</div>
				</a>
			</li>
		))}
	</ul>
</BaseLayout>
